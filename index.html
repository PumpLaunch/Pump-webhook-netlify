<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pump Sniper Pro</title>
  <!-- ‚úÖ Librairie Solana SANS espace -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
    :root {
      --bg: #0a0e27;
      --card: #131937;
      --border: #2a3457;
      --text: #ffffff;
      --green: #00ff88;
      --purple: #9945ff;
      --red: #ff3366;
      --orange: #ff9500;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      line-height: 1.5;
      padding: 16px;
    }
    .container { max-width: 700px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-size: 1.6rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--purple), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: linear-gradient(135deg, var(--purple), var(--green));
      color: white;
    }
    .btn-danger { background: var(--red); color: white; }
    .btn-secondary {
      background: var(--card);
      color: white;
      border: 1px solid var(--border);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.2rem;
      margin-bottom: 1.2rem;
    }
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .alert-danger {
      background: rgba(255, 51, 102, 0.1);
      border: 1px solid var(--red);
      color: var(--red);
    }
    .alert-success {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--green);
      color: var(--green);
    }
    .status {
      font-family: monospace;
      color: #8892b0;
      margin-top: 12px;
      font-size: 0.9rem;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: white;
      margin-bottom: 8px;
      font-family: monospace;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .stat {
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-label { font-size: 0.75rem; color: #8892b0; }
    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      font-family: monospace;
    }
    .log {
      max-height: 250px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
    }
    .log-item {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .log-time { color: #8892b0; margin-right: 8px; }
    .position-item > span {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">‚ö° PUMP SNIPER</div>
      <button id="connectBtn" class="btn btn-primary">Connecter</button>
    </div>

    <div id="app" style="display:none;">
      <div class="card">
        <div class="alert alert-success">
          <strong>‚úÖ ACHAT + REVENTE AUTO</strong><br>
          Ach√®te si: ‚â•20 holders, dev ‚â§50% ‚Üí Revend √† +X%
        </div>
        
        <div class="stats">
          <div class="stat">
            <div class="stat-label">SOLDE</div>
            <div class="stat-value" id="balance">‚Äî</div>
          </div>
          <div class="stat">
            <div class="stat-label">SCANN√âS</div>
            <div class="stat-value" id="scanned">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">ACHATS</div>
            <div class="stat-value" id="bought">0</div>
          </div>
        </div>
        
        <div style="font-family: monospace; font-size: 0.85rem; color: #8892b0;">
          <div><strong>Wallet:</strong> <span id="address">...</span></div>
          <div><strong>RPC:</strong> <span id="rpcStatus">Chargement...</span></div>
        </div>
      </div>

      <div class="card">
        <div class="alert alert-danger">
          <strong>‚ö†Ô∏è TRADING R√âEL MAINNET</strong><br>
          Montant minimum: 0.005 SOL
        </div>

        <h3 style="margin-bottom: 12px;">‚öôÔ∏è Configuration</h3>
        
        <label>üí∞ Montant (SOL):</label>
        <input type="number" id="buyAmount" value="0.005" step="0.001" min="0.005" max="1">
        
        <label>üéØ Profit cible (%):</label>
        <input type="number" id="profitTarget" value="100" min="10" max="1000" step="10">
        
        <label>üë• Holders min:</label>
        <input type="number" id="minHolders" value="20" min="5" max="100">
        
        <label>‚è±Ô∏è Scan (secondes):</label>
        <select id="scanInterval">
          <option value="15000" selected>15s</option>
          <option value="20000">20s</option>
          <option value="30000">30s</option>
        </select>
        
        <label>‚ö° Frais priorit√©:</label>
        <select id="priorityFee">
          <option value="100000" selected>√âlev√©</option>
          <option value="500000">Turbo</option>
          <option value="1000000">Max</option>
        </select>
        
        <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <button id="toggleScan" class="btn btn-primary">‚ñ∂Ô∏è Start</button>
          <button id="stopAll" class="btn btn-danger" style="display:none;">üõë Stop</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 8px;">üìú Activit√©</h3>
        <div id="log" class="log"></div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 8px;">üíº Positions</h3>
        <div id="positions" class="log"></div>
        <button id="refreshPositions" class="btn btn-secondary" style="margin-top: 8px;">üîÑ Rafra√Æchir</button>
      </div>
    </div>

    <div id="status" class="status">Cliquez sur "Connecter"</div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    
    const RPC_ENDPOINTS = [
      'https://api.mainnet-beta.solana.com',
      'https://solana-api.projectserum.com',
      'https://rpc.ankr.com/solana',
      'https://mainnet.helius-rpc.com/?api-key=43caa0a0-33d2-420c-b00a-e7261bfecf78'
    ];
    
    let currentRpcIndex = 0;
    const PUMP_PROGRAM_ID = '6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P';
    const BUY_DISCRIMINATOR = new Uint8Array([102, 6, 61, 18, 1, 218, 235, 234]);
    const SELL_DISCRIMINATOR = new Uint8Array([51, 230, 133, 164, 1, 127, 131, 173]);
    
    // ========================================
    // UTILITAIRES SANS BUFFER
    // ========================================
    
    function writeBigUInt64LE(value) {
      const buffer = new ArrayBuffer(8);
      const view = new DataView(buffer);
      view.setBigUint64(0, BigInt(value), true);
      return new Uint8Array(buffer);
    }

    function readBigUInt64LE(buffer, offset) {
      const view = new DataView(buffer.buffer, buffer.byteOffset, buffer.byteLength);
      return view.getBigUint64(offset, true);
    }

    function concatUint8Arrays(arrays) {
      const totalLength = arrays.reduceVoici le **script complet, enti√®rement mis √† jour**, int√©grant :

‚úÖ **Connexion manuelle au clic**  
‚úÖ **Achat automatique** si : ‚â•20 holders, dev ‚â§50%  
‚úÖ **Revente automatique** d√®s qu‚Äôun **% de profit cible** est atteint  
‚úÖ **Votre cl√© Helius** (`43caa0a0-33d2-420c-b00a-e7261bfecf78`)  
‚úÖ **Montant minimum** : 0.005 SOL  
‚úÖ **Affichage correct** de l‚Äôadresse (pas de `{addr.slice...}`)  
‚úÖ **RPCs sans espaces** ‚Üí pas d‚Äôerreur de chargement

---

### ‚úÖ `index.html` ‚Äî Copiez-collez ce code

```html
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Pump Sniper Pro</title>
  <!-- ‚úÖ Librairie Solana SANS espace -->
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <style>
    :root {
      --bg: #0a0e27;
      --card: #131937;
      --border: #2a3457;
      --text: #ffffff;
      --green: #00ff88;
      --purple: #9945ff;
      --red: #ff3366;
      --orange: #ff9500;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, sans-serif;
      line-height: 1.5;
      padding: 16px;
    }
    .container { max-width: 700px; margin: 0 auto; }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
      padding-bottom: 12px;
      border-bottom: 1px solid var(--border);
    }
    .logo {
      font-size: 1.6rem;
      font-weight: 800;
      background: linear-gradient(135deg, var(--purple), var(--green));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-small {
      padding: 4px 8px;
      font-size: 0.8rem;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-primary {
      background: linear-gradient(135deg, var(--purple), var(--green));
      color: white;
    }
    .btn-danger { background: var(--red); color: white; }
    .btn-secondary {
      background: var(--card);
      color: white;
      border: 1px solid var(--border);
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 1.2rem;
      margin-bottom: 1.2rem;
    }
    .alert {
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .alert-danger {
      background: rgba(255, 51, 102, 0.1);
      border: 1px solid var(--red);
      color: var(--red);
    }
    .alert-success {
      background: rgba(0, 255, 136, 0.1);
      border: 1px solid var(--green);
      color: var(--green);
    }
    .status {
      font-family: monospace;
      color: #8892b0;
      margin-top: 12px;
      font-size: 0.9rem;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border-radius: 6px;
    }
    label {
      display: block;
      margin: 8px 0 4px;
      font-weight: 500;
      font-size: 0.9rem;
    }
    input, select {
      width: 100%;
      padding: 8px;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: white;
      margin-bottom: 8px;
      font-family: monospace;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 12px;
    }
    .stat {
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
      text-align: center;
    }
    .stat-label { font-size: 0.75rem; color: #8892b0; }
    .stat-value {
      font-size: 1.2rem;
      font-weight: 700;
      font-family: monospace;
    }
    .log {
      max-height: 250px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85rem;
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 6px;
    }
    .log-item {
      padding: 4px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .log-time { color: #8892b0; margin-right: 8px; }
    .position-item > span {
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">‚ö° PUMP SNIPER</div>
      <button id="connectBtn" class="btn btn-primary">Connecter</button>
    </div>

    <div id="app" style="display:none;">
      <div class="card">
        <div class="alert alert-success">
          <strong>‚úÖ ACHAT + REVENTE AUTO</strong><br>
          Ach√®te si: ‚â•20 holders, dev ‚â§50% ‚Üí Revend √† +X%
        </div>
        
        <div class="stats">
          <div class="stat">
            <div class="stat-label">SOLDE</div>
            <div class="stat-value" id="balance">‚Äî</div>
          </div>
          <div class="stat">
            <div class="stat-label">SCANN√âS</div>
            <div class="stat-value" id="scanned">0</div>
          </div>
          <div class="stat">
            <div class="stat-label">ACHATS</div>
            <div class="stat-value" id="bought">0</div>
          </div>
        </div>
        
        <div style="font-family: monospace; font-size: 0.85rem; color: #8892b0;">
          <div><strong>Wallet:</strong> <span id="address">...</span></div>
          <div><strong>RPC:</strong> <span id="rpcStatus">Chargement...</span></div>
        </div>
      </div>

      <div class="card">
        <div class="alert alert-danger">
          <strong>‚ö†Ô∏è TRADING R√âEL MAINNET</strong><br>
          Montant minimum: 0.005 SOL
        </div>

        <h3 style="margin-bottom: 12px;">‚öôÔ∏è Configuration</h3>
        
        <label>üí∞ Montant (SOL):</label>
        <input type="number" id="buyAmount" value="0.005" step="0.001" min="0.005" max="1">
        
        <label>üéØ Profit cible (%):</label>
        <input type="number" id="profitTarget" value="100" min="10" max="1000" step="10">
        
        <label>üë• Holders min:</label>
        <input type="number" id="minHolders" value="20" min="5" max="100">
        
        <label>‚è±Ô∏è Scan (secondes):</label>
        <select id="scanInterval">
          <option value="15000" selected>15s</option>
          <option value="20000">20s</option>
          <option value="30000">30s</option>
        </select>
        
        <label>‚ö° Frais priorit√©:</label>
        <select id="priorityFee">
          <option value="100000" selected>√âlev√©</option>
          <option value="500000">Turbo</option>
          <option value="1000000">Max</option>
        </select>
        
        <div style="margin-top: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
          <button id="toggleScan" class="btn btn-primary">‚ñ∂Ô∏è Start</button>
          <button id="stopAll" class="btn btn-danger" style="display:none;">üõë Stop</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 8px;">üìú Activit√©</h3>
        <div id="log" class="log"></div>
      </div>

      <div class="card">
        <h3 style="margin-bottom: 8px;">üíº Positions</h3>
        <div id="positions" class="log"></div>
        <button id="refreshPositions" class="btn btn-secondary" style="margin-top: 8px;">üîÑ Rafra√Æchir</button>
      </div>
    </div>

    <div id="status" class="status">Cliquez sur "Connecter"</div>
  </div>

  <script>
    // ========================================
    // CONFIGURATION
    // ========================================
    
    const RPC_ENDPOINTS = [
      'https://api.mainnet-beta.solana.com',
      'https://solana-api.projectserum.com',
      'https://rpc.ankr.com/solana',
      'https://mainnet.helius-rpc.com/?api-key=43caa0a0-33d2-420c-b00a-e7261bfecf78'
    ];
    
    let currentRpcIndex = 0;
    const PUMP_PROGRAM_ID = '6EF8rrecthR5Dkzon8Nwu78hRvfCKubJ14M5uBEwF6P';
    const BUY_DISCRIMINATOR = new Uint8Array([102, 6, 61, 18, 1, 218, 235, 234]);
    const SELL_DISCRIMINATOR = new Uint8Array([51, 230, 133, 164, 1, 127, 131, 173]);
    
    // ========================================
    // UTILITAIRES SANS BUFFER
    // ========================================
    
    function writeBigUInt64LE(value) {
      const buffer = new ArrayBuffer(8);
      const view = new DataView(buffer);
      view.setBigUint64(0, BigInt(value), true);
      return new Uint8Array(buffer);
    }

    function readBigUInt64LE(buffer, offset) {
      const view = new DataView(buffer.buffer, buffer.byteOffset, buffer.byteLength);
      return view.getBigUint64(offset, true);
    }

    function concatUint8Arrays(arrays) {
      const totalLength = arrays.reduce((acc, arr) => acc + arr.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const arr of arrays) {
        result.set(arr, offset);
        offset += arr.length;
      }
      return result;
    }

    // ========================================
    // VARIABLES
    // ========================================
    
    let provider = null;
    let connection = null;
    let isScanning = false;
    let seenTokens = new Set();
    let stats = { scanned: 0, bought: 0 };
    let activeMonitors = new Map(); // mint ‚Üí timeoutId
    
    const TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');
    const ASSOCIATED_TOKEN_PROGRAM_ID = new solanaWeb3.PublicKey('ATokenGPvbdGVxr1b2hvZbsiqW5xWH25efTNsLJA8knL');
    const programId = new solanaWeb3.PublicKey(PUMP_PROGRAM_ID);
    
    const statusEl = document.getElementById('status');
    const connectBtn = document.getElementById('connectBtn');
    const toggleScanBtn = document.getElementById('toggleScan');
    const stopAllBtn = document.getElementById('stopAll');
    const addressEl = document.getElementById('address');
    const balanceEl = document.getElementById('balance');
    const scannedEl = document.getElementById('scanned');
    const boughtEl = document.getElementById('bought');
    const logEl = document.getElementById('log');
    const appEl = document.getElementById('app');
    const rpcStatusEl = document.getElementById('rpcStatus');
    const positionsEl = document.getElementById('positions');
    const refreshPositionsBtn = document.getElementById('refreshPositions');

    // ========================================
    // UTILITAIRES
    // ========================================
    
    function addLog(msg, type = 'info') {
      const now = new Date();
      const time = now.toLocaleTimeString('fr-FR');
      const color = type === 'error' ? 'var(--red)' : 
                    type === 'success' ? 'var(--green)' : 
                    type === 'warning' ? 'var(--orange)' : '#8892b0';
      
      const item = document.createElement('div');
      item.className = 'log-item';
      item.innerHTML = `<span class="log-time">[${time}]</span><span style="color:${color}">${msg}</span>`;
      logEl.insertBefore(item, logEl.firstChild);
      
      while (logEl.children.length > 50) {
        logEl.removeChild(logEl.lastChild);
      }
      
      console.log(`[${time}] ${msg}`);
      statusEl.textContent = msg;
    }

    function updateStats() {
      scannedEl.textContent = stats.scanned;
      boughtEl.textContent = stats.bought;
    }

    async function updateBalance() {
      if (!provider || !connection) return;
      try {
        const balance = await connection.getBalance(provider.publicKey);
        balanceEl.textContent = (balance / 1e9).toFixed(4);
      } catch (err) {
        console.error('Balance error:', err);
      }
    }

    // ========================================
    // RPC
    // ========================================
    
    function createConnection() {
      const rpcUrl = RPC_ENDPOINTS[currentRpcIndex];
      addLog(`üîå RPC: ${new URL(rpcUrl).hostname}`, 'info');
      rpcStatusEl.textContent = new URL(rpcUrl).hostname;
      return new solanaWeb3.Connection(rpcUrl, {
        commitment: 'confirmed',
        confirmTransactionInitialTimeout: 60000
      });
    }

    function switchRPC() {
      currentRpcIndex = (currentRpcIndex + 1) % RPC_ENDPOINTS.length;
      connection = createConnection();
      addLog(`üîÑ Changement RPC`, 'warning');
    }

    async function robustCall(fn, maxRetries = 3) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          return await fn();
        } catch (err) {
          addLog(`‚ö†Ô∏è Erreur RPC: ${err.message}`, 'warning');
          if (i < maxRetries - 1) {
            switchRPC();
            await new Promise(r => setTimeout(r, 2000));
          } else {
            throw err;
          }
        }
      }
    }

    // ========================================
    // CONNEXION MANUELLE
    // ========================================
    
    connectBtn.onclick = async () => {
      if (!window.solana || !window.solana.isPhantom) {
        addLog("‚ùå Ouvrez cette page dans l'app Phantom ‚Üí Browser", 'error');
        return;
      }
      
      try {
        addLog("üîÑ Connexion...");
        provider = window.solana;
        
        if (provider.disconnect) await provider.disconnect().catch(() => {});
        
        const { publicKey } = await provider.connect();
        connection = createConnection();
        
        const addr = publicKey.toString();
        // ‚úÖ Affichage CORRECT
        addressEl.textContent = `${addr.slice(0,6)}...${addr.slice(-4)}`;
        
        await updateBalance();
        
        appEl.style.display = 'block';
        connectBtn.style.display = 'none';
        
        addLog("‚úÖ Connect√©!", 'success');
        setInterval(updateBalance, 30000);
        
      } catch (err) {
        addLog(`‚ùå ${err.message}`, 'error');
      }
    };

    // ========================================
    // ESTIMATION SOL OUT
    // ========================================
    
    async function getEstimatedSolOut(mint, tokenAmount) {
      try {
        const mintPubkey = new solanaWeb3.PublicKey(mint);
        const [bondingCurve] = solanaWeb3.PublicKey.findProgramAddressSync(
          [new TextEncoder().encode('bonding-curve'), mintPubkey.toBuffer()],
          programId
        );

        const bondingData = await robustCall(() => connection.getAccountInfo(bondingCurve));
        if (!bondingData) return 0;

        const data = bondingData.data;
        const v_token = readBigUInt64LE(data, 8);
        const v_sol = readBigUInt64LE(data, 16);

        const token_in = BigInt(tokenAmount);
        if (token_in === 0n) return 0;

        const sol_out = (token_in * v_sol) / (v_token + token_in);
        return Number(sol_out) / 1e9;
      } catch (err) {
        return 0;
      }
    }

    // ========================================
    // SURVEILLANCE AUTOMATIQUE DU PROFIT
    // ========================================
    
    function startProfitMonitor(mint, buyAmountSol) {
      if (activeMonitors.has(mint)) return; // D√©j√† surveill√©
      
      const profitTarget = parseFloat(document.getElementById('profitTarget').value) || 100;
      const checkInterval = 5000;
      
      const check = async () => {
        try {
          const [userAta] = solanaWeb3.PublicKey.findProgramAddressSync(
            [provider.publicKey.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), new solanaWeb3.PublicKey(mint).toBuffer()],
            ASSOCIATED_TOKEN_PROGRAM_ID
          );
          
          const balanceInfo = await connection.getTokenAccountBalance(userAta);
          const tokenAmount = balanceInfo.value.amount;
          if (BigInt(tokenAmount) === 0n) {
            activeMonitors.delete(mint);
            return;
          }
          
          const estSolOut = await getEstimatedSolOut(mint, tokenAmount);
          const currentProfitPercent = ((estSolOut / buyAmountSol) - 1) * 100;
          
          if (currentProfitPercent >= profitTarget) {
            addLog(`üéØ Profit cible atteint (${profitTarget}%) ‚Üí Vente...`, 'success');
            await sellToken(mint);
            activeMonitors.delete(mint);
            return;
          }
          
          const timeoutId = setTimeout(check, checkInterval);
          activeMonitors.set(mint, timeoutId);
          
        } catch (err) {
          activeMonitors.delete(mint);
        }
      };
      
      const timeoutId = setTimeout(check, checkInterval);
      activeMonitors.set(mint, timeoutId);
    }

    // ========================================
    // ACHAT + D√âMARRAGE SURVEILLANCE
    // ========================================
    
    async function autoBuyIfValid(mintAddress) {
      if (!provider || !connection) return;

      try {
        const mintPubkey = new solanaWeb3.PublicKey(mintAddress);
        const accounts = await robustCall(() => connection.getTokenLargestAccounts(mintPubkey));
        const holders = accounts.value.length;
        
        const minHolders = parseInt(document.getElementById('minHolders').value) || 20;
        if (holders < minHolders) {
          addLog(`‚ö†Ô∏è ${mintAddress.slice(0,8)}... ‚Üí ${holders} holders (<${minHolders})`, 'warning');
          return;
        }
        
        const topHolder = accounts.value[0];
        const topPercent = topHolder ? (Number(topHolder.amount) / 1e15) * 100 : 0;
        if (topPercent > 50) {
          addLog(`‚ö†Ô∏è ${mintAddress.slice(0,8)}... ‚Üí Dev: ${topPercent.toFixed(0)}%`, 'warning');
          return;
        }

        // === ACHAT ===
        const buyAmountSol = parseFloat(document.getElementById('buyAmount').value) || 0.005;
        const priorityFee = parseInt(document.getElementById('priorityFee').value) || 100000;
        const lamports = Math.floor(buyAmountSol * solanaWeb3.LAMPORTS_PER_SOL);

        const [bondingCurve] = solanaWeb3.PublicKey.findProgramAddressSync(
          [new TextEncoder().encode('bonding-curve'), mintPubkey.toBuffer()],
          programId
        );
        
        const bondingData = await robustCall(() => connection.getAccountInfo(bondingCurve));
        if (!bondingData) return;

        const data = bondingData.data;
        const v_token = readBigUInt64LE(data, 8);
        const v_sol = readBigUInt64LE(data, 16);

        const sol_in = BigInt(lamports);
        let token_out = (sol_in * v_token) / (v_sol + sol_in);
        if (token_out === 0n) token_out = 1n;

        const slippagePercent = 10n;
        const min_token_out = token_out * (100n - slippagePercent) / 100n;
        const max_sol_cost = sol_in * (100n + slippagePercent) / 100n;

        const [bondingAta] = solanaWeb3.PublicKey.findProgramAddressSync(
          [bondingCurve.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mintPubkey.toBuffer()],
          ASSOCIATED_TOKEN_PROGRAM_ID
        );
        
        const [userAta] = solanaWeb3.PublicKey.findProgramAddressSync(
          [provider.publicKey.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mintPubkey.toBuffer()],
          ASSOCIATED_TOKEN_PROGRAM_ID
        );

        const userAtaInfo = await connection.getAccountInfo(userAta);
        const needsCreateAta = !userAtaInfo;

        const tx = new solanaWeb3.Transaction();
        tx.add(
          solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: priorityFee }),
          solanaWeb3.ComputeBudgetProgram.setComputeUnitLimit({ units: 200000 })
        );

        if (needsCreateAta) {
          tx.add(
            solanaWeb3.SystemProgram.createAccount({
              fromPubkey: provider.publicKey,
              newAccountPubkey: userAta,
              lamports: await connection.getMinimumBalanceForRentExemption(165),
              space: 165,
              programId: TOKEN_PROGRAM_ID
            }),
            new solanaWeb3.TransactionInstruction({
              keys: [
                { pubkey: userAta, isSigner: false, isWritable: true },
                { pubkey: mintPubkey, isSigner: false, isWritable: false },
                { pubkey: provider.publicKey, isSigner: false, isWritable: false }
              ],
              programId: TOKEN_PROGRAM_ID,
               new Uint8Array([1])
            })
          );
        }

        const instructionData = concatUint8Arrays([
          BUY_DISCRIMINATOR,
          writeBigUInt64LE(min_token_out),
          writeBigUInt64LE(max_sol_cost)
        ]);

        const [eventAuthority] = solanaWeb3.PublicKey.findProgramAddressSync(
          [new TextEncoder().encode('__event_authority')],
          programId
        );

        tx.add(new solanaWeb3.TransactionInstruction({
          keys: [
            { pubkey: new solanaWeb3.PublicKey('4wTV1YmiEkRvAtNtsSGPtUrqRYQMe5SKy2uB4Jjaxnjf'), isSigner: false, isWritable: false },
            { pubkey: new solanaWeb3.PublicKey('CebN5WGQ4jvEPvsVU4EoHEpgzq1VV7AbicfhtW4xC9iM'), isSigner: false, isWritable: true },
            { pubkey: mintPubkey, isSigner: false, isWritable: false },
            { pubkey: bondingCurve, isSigner: false, isWritable: true },
            { pubkey: bondingAta, isSigner: false, isWritable: true },
            { pubkey: userAta, isSigner: false, isWritable: true },
            { pubkey: provider.publicKey, isSigner: true, isWritable: true },
            { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: new solanaWeb3.PublicKey('SysvarRent111111111111111111111111111111111'), isSigner: false, isWritable: false },
            { pubkey: eventAuthority, isSigner: false, isWritable: false },
            { pubkey: programId, isSigner: false, isWritable: false }
          ],
          programId: programId,
           instructionData
        }));

        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        tx.feePayer = provider.publicKey;

        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        
        addLog(`‚úÖ ACHAT CONFIRM√â ! https://solscan.io/tx/${sig}`, 'success');
        stats.bought++;
        updateStats();
        updateBalance();

        // ‚úÖ D√âMARRER LA SURVEILLANCE DU PROFIT
        startProfitMonitor(mintAddress, buyAmountSol);

      } catch (err) {
        addLog(`‚ùå √âchec achat: ${err.message}`, 'error');
      }
    }

    // ========================================
    // VENTE
    // ========================================
    
    async function sellToken(mintAddress) {
      try {
        const mintPubkey = new solanaWeb3.PublicKey(mintAddress);
        const [userAta] = solanaWeb3.PublicKey.findProgramAddressSync(
          [provider.publicKey.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mintPubkey.toBuffer()],
          ASSOCIATED_TOKEN_PROGRAM_ID
        );

        const balanceInfo = await robustCall(() => connection.getTokenAccountBalance(userAta));
        const tokenAmount = BigInt(balanceInfo.value.amount);
        if (tokenAmount === 0n) return;

        const priorityFee = parseInt(document.getElementById('priorityFee').value) || 100000;

        const [bondingCurve] = solanaWeb3.PublicKey.findProgramAddressSync(
          [new TextEncoder().encode('bonding-curve'), mintPubkey.toBuffer()],
          programId
        );

        const bondingData = await robustCall(() => connection.getAccountInfo(bondingCurve));
        if (!bondingData) throw new Error('Bonding data not found');

        const data = bondingData.data;
        const v_token = readBigUInt64LE(data, 8);
        const v_sol = readBigUInt64LE(data, 16);

        const token_in = tokenAmount;
        let sol_out = (token_in * v_sol) / (v_token + token_in);
        if (sol_out === 0n) sol_out = 1n;

        const slippagePercent = 10n;
        const min_sol_out = sol_out * (100n - slippagePercent) / 100n;

        const [bondingAta] = solanaWeb3.PublicKey.findProgramAddressSync(
          [bondingCurve.toBuffer(), TOKEN_PROGRAM_ID.toBuffer(), mintPubkey.toBuffer()],
          ASSOCIATED_TOKEN_PROGRAM_ID
        );

        const [eventAuthority] = solanaWeb3.PublicKey.findProgramAddressSync(
          [new TextEncoder().encode('__event_authority')],
          programId
        );

        const tx = new solanaWeb3.Transaction();
        tx.add(
          solanaWeb3.ComputeBudgetProgram.setComputeUnitPrice({ microLamports: priorityFee }),
          solanaWeb3.ComputeBudgetProgram.setComputeUnitLimit({ units: 200000 })
        );

        const instructionData = concatUint8Arrays([
          SELL_DISCRIMINATOR,
          writeBigUInt64LE(token_in),
          writeBigUInt64LE(min_sol_out)
        ]);

        tx.add(new solanaWeb3.TransactionInstruction({
          keys: [
            { pubkey: new solanaWeb3.PublicKey('4wTV1YmiEkRvAtNtsSGPtUrqRYQMe5SKy2uB4Jjaxnjf'), isSigner: false, isWritable: false },
            { pubkey: new solanaWeb3.PublicKey('CebN5WGQ4jvEPvsVU4EoHEpgzq1VV7AbicfhtW4xC9iM'), isSigner: false, isWritable: true },
            { pubkey: mintPubkey, isSigner: false, isWritable: false },
            { pubkey: bondingCurve, isSigner: false, isWritable: true },
            { pubkey: bondingAta, isSigner: false, isWritable: true },
            { pubkey: userAta, isSigner: false, isWritable: true },
            { pubkey: provider.publicKey, isSigner: true, isWritable: true },
            { pubkey: solanaWeb3.SystemProgram.programId, isSigner: false, isWritable: false },
            { pubkey: ASSOCIATED_TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: TOKEN_PROGRAM_ID, isSigner: false, isWritable: false },
            { pubkey: eventAuthority, isSigner: false, isWritable: false },
            { pubkey: programId, isSigner: false, isWritable: false }
          ],
          programId: programId,
           instructionData
        ));

        const { blockhash } = await connection.getLatestBlockhash();
        tx.recentBlockhash = blockhash;
        tx.feePayer = provider.publicKey;

        const signed = await provider.signTransaction(tx);
        const sig = await connection.sendRawTransaction(signed.serialize());
        
        addLog(`‚úÖ VENTE CONFIRM√âE ! https://solscan.io/tx/${sig}`, 'success');
        updateBalance();

      } catch (err) {
        addLog(`‚ùå √âchec vente: ${err.message}`, 'error');
      }
    }

    // ========================================
    // SCANNER
    // ========================================
    
    async function scan() {
      try {
        const sigs = await robustCall(() =>
          connection.getSignaturesForAddress(
            new solanaWeb3.PublicKey(PUMP_PROGRAM_ID),
            { limit: 3 }
          )
        );
        
        stats.scanned += sigs.length;
        updateStats();
        
        for (const sig of sigs) {
          if (seenTokens.has(sig.signature)) continue;
          seenTokens.add(sig.signature);
          
          const tx = await robustCall(() =>
            connection.getParsedTransaction(sig.signature, { maxSupportedTransactionVersion: 0 })
          );
          
          if (!tx) continue;
          
          for (const ix of tx.transaction.message.instructions) {
            if (ix.programId.toString() === PUMP_PROGRAM_ID) {
              const accs = ix.accounts;
              if (accs && accs.length > 2) {
                const mint = accs[2].toString();
                if (mint === '11111111111111111111111111111111') continue;
                
                addLog(`üÜï Token d√©tect√©: ${mint.slice(0,8)}...`, 'info');
                autoBuyIfValid(mint);
              }
            }
          }
        }
        
      } catch (err) {
        addLog(`‚ö†Ô∏è Erreur scan`, 'warning');
      }
    }

    // ========================================
    // CONTR√îLES
    // ========================================
    
    toggleScanBtn.onclick = () => {
      if (!isScanning) {
        const interval = parseInt(document.getElementById('scanInterval').value);
        isScanning = true;
        toggleScanBtn.textContent = "‚è∏Ô∏è Pause";
        toggleScanBtn.className = "btn btn-secondary";
        stopAllBtn.style.display = "block";
        addLog("üöÄ START", 'success');
        setInterval(scan, interval);
        scan();
      } else {
        isScanning = false;
        toggleScanBtn.textContent = "‚ñ∂Ô∏è Start";
        toggleScanBtn.className = "btn btn-primary";
        addLog("‚è∏Ô∏è Pause", 'warning');
      }
    };

    stopAllBtn.onclick = () => {
      isScanning = false;
      toggleScanBtn.textContent = "‚ñ∂Ô∏è Start";
      toggleScanBtn.className = "btn btn-primary";
      stopAllBtn.style.display = "none";
      seenTokens.clear();
      stats = { scanned: 0, bought: 0 };
      updateStats();
      // Arr√™ter tous les moniteurs
      for (const [mint, timeoutId] of activeMonitors.entries()) {
        clearTimeout(timeoutId);
      }
      activeMonitors.clear();
      addLog("üõë STOP", 'error');
    };

    refreshPositionsBtn.onclick = () => {
      addLog("üîÑ Rafra√Æchissement manuel des positions", 'info');
    };
  </script>
</body>
</html>
